<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>カードリスト</title>
	<link rel="stylesheet" th:href="@{/css/cardList.css}">
	<link rel="stylesheet" th:href="@{/css/common/header.css}">
</head>

<body>
	<header th:replace="~{html/common/header :: layout-header}"></header>
	<main>
		<div class="cardlist-container">
			<h1>カードリスト</h1>
			<div class="cardlist-search">
				<h2>カード検索</h2>
				<!-- 詳細検索トグルボタン -->
				<div class="cardlist-search-toggle">
					<button type="button" class="cardlist-search-toggle-btn" onclick="toggleDetailSearch()">
						<span class="toggle-icon">▼</span>
						<span class="toggle-text">詳細検索</span>
					</button>
				</div>
				<form th:action="@{/card/list/search}" th:object="${cardListForm}" method="post" novalidate>
					<div id="detailSearchArea" class="cardlist-search-details">
						
						<div class="search-section">
							<div class="search-row">
								<div class="search-field full-width">
									<label class="field-label">カード名</label>
									<input type="text" th:field="*{cardName}" placeholder="カード名を入力" />
								</div>
							</div>
							
							<div class="search-row">
								<div class="search-field">
									<label class="field-label">色</label>
									<div class="checkbox-group">
										<th:block th:each="color : ${T(jp.co.sss.onepiececardviewer.enums.CardColor).values()}">
											<label class="checkbox-label">
												<input type="checkbox" th:field="*{cardColor}" th:value="${color}" />
												<span class="checkbox-text" th:text="${color}"></span>
											</label>
										</th:block>
									</div>
								</div>
							</div>
							
							<div class="search-row">
								<div class="search-field">
									<label class="field-label">種類</label>
									<div class="checkbox-group">
										<th:block th:each="type : ${T(jp.co.sss.onepiececardviewer.enums.CardType).values()}">
											<label class="checkbox-label">
												<input type="checkbox" th:field="*{cardType}" th:value="${type}" />
												<span class="checkbox-text" th:text="${type}"></span>
											</label>
										</th:block>
									</div>
								</div>
							</div>
							
							<div class="search-row">
								<div class="search-field">
									<label class="field-label">レアリティ</label>
									<div class="checkbox-group">
										<th:block th:each="rarity : ${T(jp.co.sss.onepiececardviewer.enums.CardRarity).values()}">
											<label class="checkbox-label">
												<input type="checkbox" th:field="*{cardRarity}" th:value="${rarity}" />
												<span class="checkbox-text" th:text="${rarity}"></span>
											</label>
										</th:block>
									</div>
								</div>
							</div>
							
							<div class="search-row">
								<div class="search-field half-width">
									<label class="field-label">収録パック</label>
									<select th:field="*{cardPack}">
										<option value="">すべて</option>
										<option th:each="pack : ${T(jp.co.sss.onepiececardviewer.enums.CardPack).values()}"
												th:value="${pack}"
												th:text="${pack.displayName}">
										</option>
									</select>
								</div>
							</div>
						</div>
						
						<div class="search-section">
							<div class="search-row">
								<div class="search-field range-field">
									<label class="field-label">ブロックアイコン</label>
									<div class="range-inputs">
										<select th:field="*{minCardBlockIcon}">
											<option value="">下限なし</option>
											<option th:value="1">1</option>
											<option th:value="2">2</option>
											<option th:value="3">3</option>
											<option th:value="4">4</option>
										</select>
										<span class="range-separator">〜</span>
										<select th:field="*{maxCardBlockIcon}">
											<option value="">上限なし</option>
											<option th:value="1">1</option>
											<option th:value="2">2</option>
											<option th:value="3">3</option>
											<option th:value="4">4</option>
										</select>
									</div>
								</div>
							</div>
							
							<div class="search-row">
								<div class="search-field range-field">
									<label class="field-label">コスト / ライフ</label>
									<div class="range-inputs">
										<select th:field="*{minCardCostOrLife}">
											<option value="">下限なし</option>
											<option th:value="0">0</option>
											<option th:value="1">1</option>
											<option th:value="2">2</option>
											<option th:value="3">3</option>
											<option th:value="4">4</option>
											<option th:value="5">5</option>
											<option th:value="6">6</option>
											<option th:value="7">7</option>
											<option th:value="8">8</option>
											<option th:value="9">9</option>
											<option th:value="10">10</option>
										</select>
										<span class="range-separator">〜</span>
										<select th:field="*{maxCardCostOrLife}">
											<option value="">上限なし</option>
											<option th:value="0">0</option>
											<option th:value="1">1</option>
											<option th:value="2">2</option>
											<option th:value="3">3</option>
											<option th:value="4">4</option>
											<option th:value="5">5</option>
											<option th:value="6">6</option>
											<option th:value="7">7</option>
											<option th:value="8">8</option>
											<option th:value="9">9</option>
											<option th:value="10">10</option>
										</select>
									</div>
								</div>
							</div>
							
							<div class="search-row">
								<div class="search-field range-field">
									<label class="field-label">パワー</label>
									<div class="range-inputs">
										<select th:field="*{minCardPower}">
											<option value="">下限なし</option>
											<option th:value="0">0</option>
											<option th:value="1000">1000</option>
											<option th:value="2000">2000</option>
											<option th:value="3000">3000</option>
											<option th:value="4000">4000</option>
											<option th:value="5000">5000</option>
											<option th:value="6000">6000</option>
											<option th:value="7000">7000</option>
											<option th:value="8000">8000</option>
											<option th:value="9000">9000</option>
											<option th:value="10000">10000</option>
											<option th:value="11000">11000</option>
											<option th:value="12000">12000</option>
											<option th:value="13000">13000</option>
										</select>
										<span class="range-separator">〜</span>
										<select th:field="*{maxCardPower}">
											<option value="">上限なし</option>
											<option th:value="0">0</option>
											<option th:value="1000">1000</option>
											<option th:value="2000">2000</option>
											<option th:value="3000">3000</option>
											<option th:value="4000">4000</option>
											<option th:value="5000">5000</option>
											<option th:value="6000">6000</option>
											<option th:value="7000">7000</option>
											<option th:value="8000">8000</option>
											<option th:value="9000">9000</option>
											<option th:value="10000">10000</option>
											<option th:value="11000">11000</option>
											<option th:value="12000">12000</option>
											<option th:value="13000">13000</option>
										</select>
									</div>
								</div>
							</div>
							
							<div class="search-row">
								<div class="search-field">
									<label class="field-label">カウンター値</label>
									<div class="checkbox-group">
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardCounter}" th:value="0" />
											<span class="checkbox-text">なし</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardCounter}" th:value="1000" />
											<span class="checkbox-text">1000</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardCounter}" th:value="2000" />
											<span class="checkbox-text">2000</span>
										</label>
									</div>
								</div>
							</div>
						</div>
						
						<div class="search-section">
							<div class="search-row">
								<div class="search-field">
									<label class="field-label">属性</label>
									<div class="checkbox-group">
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardFeatures}" th:value="打" />
											<span class="checkbox-text">打</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardFeatures}" th:value="射" />
											<span class="checkbox-text">射</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardFeatures}" th:value="特" />
											<span class="checkbox-text">特</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardFeatures}" th:value="知" />
											<span class="checkbox-text">知</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardFeatures}" th:value="斬" />
											<span class="checkbox-text">斬</span>
										</label>
									</div>
								</div>
							</div>
							
							<div class="search-row">
								<div class="search-field half-width">
									<label class="field-label">特徴</label>
									<select th:field="*{cardAttribute}">
										<option value="">すべて</option>
										<option th:value="超新星">超新星</option>
										<option th:value="麦わらの一味">麦わらの一味</option>
										<option th:value="動物">動物</option>
										<option th:value="アラバスタ王国">アラバスタ王国</option>
										<option th:value="魚人族">魚人族</option>
										<option th:value="キッド海賊団">キッド海賊団</option>
										<option th:value="ファイアタンク海賊団">ファイアタンク海賊団</option>
										<option th:value="破戒僧海賊団">破戒僧海賊団</option>
										<option th:value="海軍">海軍</option>
										<option th:value="ボニー海賊団">ボニー海賊団</option>
										<option th:value="オンエア海賊団">オンエア海賊団</option>
										<option th:value="ハートの海賊団">ハートの海賊団</option>
										<option th:value="ホーキンス海賊団">ホーキンス海賊団</option>
										<option th:value="ミンク族">ミンク族</option>
										<option th:value="ドレーク海賊団">ドレーク海賊団</option>
										<option th:value="王下七武海">王下七武海</option>
										<option th:value="B・W">B・W</option>
										<option th:value="スリラーバーク海賊団">スリラーバーク海賊団</option>
										<option th:value="タイヨウの海賊団">タイヨウの海賊団</option>
										<option th:value="ドンキホーテ海賊団">ドンキホーテ海賊団</option>
										<option th:value="革命軍">革命軍</option>
										<option th:value="バギーズ・デリバリー">バギーズ・デリバリー</option>
										<option th:value="九蛇海賊団">九蛇海賊団</option>
										<option th:value="黒ひげ海賊団">黒ひげ海賊団</option>
										<option th:value="四皇">四皇</option>
										<option th:value="百獣海賊団">百獣海賊団</option>
										<option th:value="SMILE">SMILE</option>
									</select>
								</div>
							</div>
						</div>
						
						<div class="search-section">
							<div class="search-row">
								<div class="search-field full-width">
									<label class="field-label">テキスト効果</label>
									<input type="text" th:field="*{cardText}" placeholder="テキスト効果を入力" />
								</div>
							</div>
							
							<div class="search-row">
								<div class="search-field full-width trigger-field">
									<label class="field-label">
										<input type="checkbox" th:field="*{cardTrigger}" th:value="1" />
										<span class="checkbox-text">トリガー</span>
									</label>
									<input type="text" th:field="*{cardTriggerText}" placeholder="トリガーテキストを入力" class="trigger-text-input" />
								</div>
							</div>
						</div>
						
						<div class="search-section">
							<div class="search-row">
								<div class="search-field">
									<div class="checkbox-grid">
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardAppearance}" th:value="1" />
											<span class="checkbox-text">登場時</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardLaunchMain}" th:value="1" />
											<span class="checkbox-text">起動メイン</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardAttack}" th:value="1" />
											<span class="checkbox-text">アタック時</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardKO}" th:value="1" />
											<span class="checkbox-text">KO時</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardBlock}" th:value="1" />
											<span class="checkbox-text">ブロック時</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardDuringYourTurn}" th:value="1" />
											<span class="checkbox-text">自分のターン中</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardDuringOpponentTurn}" th:value="1" />
											<span class="checkbox-text">相手のターン中</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardYourTurnEnd}" th:value="1" />
											<span class="checkbox-text">自分のターン終了時</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardOpponentAttack}" th:value="1" />
											<span class="checkbox-text">相手のアタック時</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardMain}" th:value="1" />
											<span class="checkbox-text">メイン効果</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardEventCounter}" th:value="1" />
											<span class="checkbox-text">イベントカウンター</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardOneTurn}" th:value="1" />
											<span class="checkbox-text">ターン1回</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardDonHang}" th:value="1" />
											<span class="checkbox-text">ドン!!×n</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardDonMinus}" th:value="1" />
											<span class="checkbox-text">ドン!!-n</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardBlocker}" th:value="1" />
											<span class="checkbox-text">ブロッカー</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardHaste}" th:value="1" />
											<span class="checkbox-text">速攻</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardDoubleAttack}" th:value="1" />
											<span class="checkbox-text">ダブルアタック</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardVanish}" th:value="1" />
											<span class="checkbox-text">バニッシュ</span>
										</label>
									</div>
								</div>
							</div>
						</div>
						
						<div class="search-actions">
							<button type="submit" class="search-submit-btn">検索する</button>
						</div>
					</div>
				</form>
			</div>
			<div class="cardlist-image-grid">
				<div class="cardlist-image-card" th:each="image : ${images}">
					<a href="javascript:void(0);" th:attr="data-id=${image.id}" onclick="openCardModal(this.dataset.id)">
						<img th:src="@{/card/list/file/{id}(id=${image.id})}" th:alt="${image.cardName}">
					</a>
				</div>
			</div>
		</div>
		
		<!-- モーダルダイアログ -->
		<div id="cardModal" class="cardlist-modal">
			<div class="cardlist-modal-content">
				<span class="cardlist-modal-close" onclick="closeCardModal()">&times;</span>
				<div class="cardlist-modal-body">
					<div class="cardlist-modal-image">
						<img id="modalImage" src="" alt="NoImage">
					</div>
					<div class="cardlist-modal-details">
						<div class="cardlist-overlay-cardname">
							<h1><span id="modalCardName"></span></h1>
							<p><span id="modalCardNumber"></span></p>
						</div>
						<div class="cardlist-overlay-others">
							<p>色:<span id="modalCardColor"></span></p>
							<p>種類:<span id="modalCardType"></span></p>
							<p>コストまたはライフ:<span id="modalCardCostOrLife"></span></p>
							<p>パワー:<span id="modalCardPower"></span></p>
							<p>カウンター:<span id="modalCardCounter"></span></p>
							<p>特徴:<span id="modalCardAttribute"></span></p>
							<p>属性:<span id="modalCardFeatures"></span></p>
							<p>テキスト:<span id="modalCardText"></span></p>
							<div id="modalTriggerSection" style="display: none;">
								<p>トリガー:<span id="modalCardTriggerText"></span></p>
							</div>
							<p>入手情報:<span id="modalCardPack"></span></p>
						</div>
					</div>
				</div>
			</div>
		</div>
	</main>
	
	<script>
		function toggleDetailSearch() {
			const detailArea = document.getElementById('detailSearchArea');
			const button = document.querySelector('.cardlist-search-toggle-btn');
			
			if (detailArea.classList.contains('active')) {
				detailArea.classList.remove('active');
				button.textContent = '詳細検索';
			} else {
				detailArea.classList.add('active');
				button.textContent = '詳細検索を閉じる';
			}
		}
		
		// モーダルを開く関数
		function openCardModal(cardId) {
			fetch('/card/list/detail/' + cardId)
				.then(response => {
					if (!response.ok) {
						throw new Error('No Image');
					}
					return response.json();
				})
				.then(card => {
					document.getElementById('modalImage').src = '/card/list/file/' + card.id;
					document.getElementById('modalCardName').textContent = card.cardName || '';
					document.getElementById('modalCardNumber').textContent = card.cardNumber || '';
					document.getElementById('modalCardColor').textContent = card.cardColor || '';
					document.getElementById('modalCardType').textContent = card.cardType || '';
					document.getElementById('modalCardCostOrLife').textContent = card.cardCostOrLife || '';
					document.getElementById('modalCardPower').textContent = card.cardPower || '';
					document.getElementById('modalCardCounter').textContent = card.cardCounter || '';
					document.getElementById('modalCardAttribute').textContent = card.cardAttribute || '';
					document.getElementById('modalCardFeatures').textContent = card.cardFeatures || '';
					document.getElementById('modalCardText').textContent = card.cardText || '';
					document.getElementById('modalCardPack').textContent = card.cardPack || '';
					
					const triggerSection = document.getElementById('modalTriggerSection');
					if (card.cardTrigger) {
						document.getElementById('modalCardTriggerText').textContent = card.cardTriggerText || '';
						triggerSection.style.display = 'block';
					} else {
						triggerSection.style.display = 'none';
					}
					
					document.getElementById('cardModal').classList.add('active');
				})
				.catch(error =>{
					console.error('エラー:', error);
					alert('カード情報の取得に失敗しました');
				});
		}
		
		function closeCardModal() {
			document.getElementById('cardModal').classList.remove('active');
		}
		
		window.onclick = function(event) {
			const modal = document.getElementById('cardModal');
			if (event.target === modal) {
				closeCardModal();
			}
		}
		
		document.addEventListener('keydown', function(event) {
			if (event.key === 'Escape') {
				closeCardModal();
			}
		})
		
		// ページネーション機能
		const CARDS_PER_PAGE = 30; // 1ページあたりのカード数（5-6行 × 5-6列）
		let currentPage = 1;
		let allCards = [];
		
		document.addEventListener('DOMContentLoaded', function() {
			// すべてのカードを取得
			const cardGrid = document.querySelector('.cardlist-image-grid');
			if (cardGrid) {
				allCards = Array.from(cardGrid.querySelectorAll('.cardlist-image-card'));
				
				// ページネーションを初期化
				initPagination();
				showPage(1);
			}
		});
		
		function initPagination() {
			const cardGrid = document.querySelector('.cardlist-image-grid');
			const container = cardGrid.parentElement;
			
			// 上部のページネーションを追加
			const topPagination = createPaginationHTML();
			cardGrid.insertAdjacentHTML('beforebegin', topPagination);
			
			// 下部のページネーションを追加
			const bottomPagination = createPaginationHTML();
			cardGrid.insertAdjacentHTML('afterend', bottomPagination);
		}
		
		function createPaginationHTML() {
			return '<div class="pagination"></div>';
		}
		
		function showPage(page) {
			currentPage = page;
			const totalPages = Math.ceil(allCards.length / CARDS_PER_PAGE);
			
			// すべてのカードを非表示
			allCards.forEach(card => card.style.display = 'none');
			
			// 現在のページのカードを表示
			const startIndex = (page - 1) * CARDS_PER_PAGE;
			const endIndex = startIndex + CARDS_PER_PAGE;
			const cardsToShow = allCards.slice(startIndex, endIndex);
			cardsToShow.forEach(card => card.style.display = 'block');
			
			// ページネーションボタンを更新
			updatePaginationButtons(page, totalPages);
			
			// ページトップにスクロール
			window.scrollTo({ top: 0, behavior: 'smooth' });
		}
		
		function updatePaginationButtons(currentPage, totalPages) {
			const paginationContainers = document.querySelectorAll('.pagination');
			
			paginationContainers.forEach(container => {
				container.innerHTML = '';
				
				// 前へボタン
				const prevBtn = document.createElement('button');
				prevBtn.className = 'pagination-btn';
				prevBtn.innerHTML = '←';
				prevBtn.disabled = currentPage === 1;
				prevBtn.onclick = () => showPage(currentPage - 1);
				container.appendChild(prevBtn);
				
				// ページ番号ボタン
				const pageNumbers = getPageNumbers(currentPage, totalPages);
				pageNumbers.forEach(pageNum => {
					if (pageNum === null) {
						// 空白のスペーサー
						const spacer = document.createElement('span');
						spacer.className = 'pagination-number';
						spacer.style.visibility = 'hidden'; // 非表示だが幅は確保
						spacer.textContent = '0';
						container.appendChild(spacer);
					} else if (pageNum === '...') {
						const ellipsis = document.createElement('span');
						ellipsis.className = 'pagination-ellipsis';
						ellipsis.textContent = '...';
						container.appendChild(ellipsis);
					} else {
						const pageBtn = document.createElement('button');
						pageBtn.className = 'pagination-number';
						if (pageNum === currentPage) {
							pageBtn.classList.add('active');
						}
						pageBtn.textContent = pageNum;
						pageBtn.onclick = () => showPage(pageNum);
						container.appendChild(pageBtn);
					}
				});
				
				// 次へボタン
				const nextBtn = document.createElement('button');
				nextBtn.className = 'pagination-btn';
				nextBtn.innerHTML = '→';
				nextBtn.disabled = currentPage === totalPages;
				nextBtn.onclick = () => showPage(currentPage + 1);
				container.appendChild(nextBtn);
			});
		}
		
		function getPageNumbers(current, total) {
			const pages = [];
			const maxButtons = 9; // 常に9個のボタン（矢印除く）を表示
			
			if (total <= maxButtons) {
				// 総ページ数が9以下の場合はすべて表示
				for (let i = 1; i <= total; i++) {
					pages.push(i);
				}
				// ボタン数を9個に揃えるため、空白を追加
				while (pages.length < maxButtons) {
					pages.push(null); // nullは非表示の要素として扱う
				}
			} else {
				// 常に「1 ... 中間5つ ... 最終」の形式で9個表示
				pages.push(1);
				pages.push('...');
				
				// 現在のページを中心に5つのページ番号を表示
				let start = Math.max(2, current - 2);
				let end = Math.min(total - 1, current + 2);
				
				// 端に寄っている場合は調整
				if (current <= 4) {
					start = 2;
					end = 6;
				} else if (current >= total - 3) {
					start = total - 5;
					end = total - 1;
				}
				
				for (let i = start; i <= end; i++) {
					pages.push(i);
				}
				
				pages.push('...');
				pages.push(total);
			}
			
			return pages;
		}
	</script>
</body>

</html>