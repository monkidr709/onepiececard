<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>デッキ作成</title>
	<link rel="stylesheet" th:href="@{/css/choiceLeader.css}">
	<link rel="stylesheet" th:href="@{/css/common/header.css}">
</head>

<body>
	<header th:replace="~{html/common/header :: layout-header}"></header>
	<main>
		<div class="choiceleader-container">
			<h1>リーダー選択</h1>
			<div class="choiceleader-search">
				<div id="searchLeader" class="choiceleader-search-leader">
					<button type="button" value="">全</button>
					<button type="button" value="赤">赤</button>
					<button type="button" value="緑">緑</button>
					<button type="button" value="青">青</button>
					<button type="button" value="紫">紫</button>
					<button type="button" value="黒">黒</button>
					<button type="button" value="黄">黄</button>
				</div>
			</div>
			<div class="choiceleader-image-grid">
				<div class="choiceleader-image-card" th:each="leaderImage : ${leaderImages}" th:data-color="${leaderImage.cardColor}">
					<a href="javascript:void(0);" th:onclick="'openLeaderCardModal(' + ${leaderImage.id} + ')'">
						<img th:src="@{/card/list/file/{id}(id=${leaderImage.id})}" th:alt="${leaderImage.cardName}">
					</a>
				</div>
			</div>
		</div>
		
		<!-- モーダルダイアログ -->
		<div id="leaderCardModal" class="choiceleader-modal">
			<div class="choiceleader-modal-content">
				<span class="choiceleader-modal-close" onclick="closeLeaderCardModal()">&times;</span>
				<div class="choiceleader-modal-body">
					<div class="choiceleader-modal-confirmation">
						<p>このリーダーでよろしいですか。</p>
					</div>
					<div class="choiceleader-modal-image">
						<img id="modalImage" src="" alt="NoImage">
					</div>
					<div class="choiceleader-modal-button">
						<form id="modalForm" action="" method="post">
							<button type="submit">作成</button>
						</form>
					</div>
				</div>
			</div>
		</div>
	</main>
	
	<script>
		//色でリーダーを検索する関数
		function searchLeader(color) {
			const leaderCards = document.querySelectorAll('.choiceleader-image-card');
			leaderCards.forEach(card => {
				const leaderCardColor = card.dataset.color;
				if (color === '' || leaderCardColor.includes(color)) {
					card.style.display = 'block';
				} else {
					card.style.display = 'none';
				}
			})
		}
		
		//ボタンをクリックしたら色でリーダー検索する
		document.getElementById('searchLeader').addEventListener('click', function(event) {
			if (event.target.tagName === 'BUTTON') {
				const color = event.target.value;
				searchLeader(color);
			}
		})
		
		//モーダルを開く関数
		function openLeaderCardModal(cardId) {
			//Ajaxでカード詳細を取得
			fetch('/card/list/detail/' + cardId)
				.then(response => {
					if (!response.ok) {
						throw new Error('No Image');
					}
					return response.json();
				})
				.then(card => {
					//モーダルに情報を設定
					document.getElementById('modalImage').src = '/card/list/file/' + card.id;
					document.getElementById('modalForm').action = '/create/deck/' + card.id;
					
					//モーダルを表示
					document.getElementById('leaderCardModal').classList.add('active');
				})
				.catch(error =>{
					console.error('エラー:', error);
					alert('カード情報の取得に失敗しました');
				});
		}
		
		//モーダルを閉じる関数
		function closeLeaderCardModal() {
			document.getElementById('leaderCardModal').classList.remove('active');
		}
		
		//モーダルの背景をクリックしたら閉じる
		window.onclick = function(event) {
			const modal = document.getElementById('leaderCardModal');
			if (event.target === modal) {
				closeLeaderCardModal();
			}
		}
		
		//ESCキーでモーダルを閉じる
		document.addEventListener('keydown', function(event) {
			if (event.key === 'Escape') {
				closeLeaderCardModal();
			}
		})
	</script>
</body>

</html>