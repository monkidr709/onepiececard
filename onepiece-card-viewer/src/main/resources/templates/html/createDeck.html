<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>デッキ作成</title>
	<link rel="stylesheet" th:href="@{/css/createDeck.css}">
</head>

<body>
	<main>
		<div class="createDeck-container">
			<h1>デッキ作成</h1>
			<div class="createDeck-search" th:each="leaderCard : ${leaderCard}">
				<h2>カード検索</h2>
				<div class="createDeck-search-toggle">
					<button type="button" class="createDeck-search-toggle-btn" onclick="toggleDetailSearch()">詳細検索</button>
				</div>
				<form th:action="@{/create/deck/search/{id}(id=${leaderCard.id})}" th:object="${cardListForm}" method="post" onsubmit="saveDeckToSession()" novalidate>
					<input type="hidden" id="searchDeckDataField" name="deckData" value="" />
					<div id="detailSearchArea" class="createDeck-search-details">
						
						<div class="search-section">
							<div class="search-row">
								<div class="search-field full-width">
									<label class="field-label">カード名</label>
									<input type="text" th:field="*{cardName}" placeholder="カード名を入力" />
								</div>
							</div>
							
							<div class="search-row">
								<div class="search-field full-width">
									<label class="field-label">色</label>
									<div class="checkbox-group">
										<label class="checkbox-label" th:if="${#lists.contains(leaderCard.cardColor, '赤')}">
											<input type="checkbox" th:field="*{cardColor}" th:value="赤" />
											<span class="checkbox-text">赤</span>
										</label>
										<label class="checkbox-label" th:if="${#lists.contains(leaderCard.cardColor, '緑')}">
											<input type="checkbox" th:field="*{cardColor}" th:value="緑" />
											<span class="checkbox-text">緑</span>
										</label>
										<label class="checkbox-label" th:if="${#lists.contains(leaderCard.cardColor, '青')}">
											<input type="checkbox" th:field="*{cardColor}" th:value="青" />
											<span class="checkbox-text">青</span>
										</label>
										<label class="checkbox-label" th:if="${#lists.contains(leaderCard.cardColor, '紫')}">
											<input type="checkbox" th:field="*{cardColor}" th:value="紫" />
											<span class="checkbox-text">紫</span>
										</label>
										<label class="checkbox-label" th:if="${#lists.contains(leaderCard.cardColor, '黒')}">
											<input type="checkbox" th:field="*{cardColor}" th:value="黒" />
											<span class="checkbox-text">黒</span>
										</label>
										<label class="checkbox-label" th:if="${#lists.contains(leaderCard.cardColor, '黄')}">
											<input type="checkbox" th:field="*{cardColor}" th:value="黄" />
											<span class="checkbox-text">黄</span>
										</label>
									</div>
								</div>
							</div>
							
							<div class="search-row">
								<div class="search-field full-width">
									<label class="field-label">種類</label>
									<div class="checkbox-group">
										<th:block th:each="type : ${T(jp.co.sss.onepiececardviewer.enums.CardType2).values()}">
											<label class="checkbox-label">
												<input type="checkbox" th:field="*{cardType}" th:value="${type}" />
												<span class="checkbox-text" th:text="${type}"></span>
											</label>
										</th:block>
									</div>
								</div>
							</div>
							
							<div class="search-row">
								<div class="search-field full-width">
									<label class="field-label">レアリティ</label>
									<div class="checkbox-group">
										<th:block th:each="rarity : ${T(jp.co.sss.onepiececardviewer.enums.CardRarity2).values()}">
											<label class="checkbox-label">
												<input type="checkbox" th:field="*{cardRarity}" th:value="${rarity}" />
												<span class="checkbox-text" th:text="${rarity}"></span>
											</label>
										</th:block>
									</div>
								</div>
							</div>
							
							<div class="search-row">
								<div class="search-field half-width">
									<label class="field-label">収録パック</label>
									<select th:field="*{cardPack}">
										<option value="">すべて</option>
										<option th:each="pack : ${T(jp.co.sss.onepiececardviewer.enums.CardPack).values()}"
												th:value="${pack}"
												th:text="${pack.displayName}">
										</option>
									</select>
								</div>
							</div>
						</div>
						
						<div class="search-section">
							<div class="search-row">
								<div class="search-field range-field">
									<label class="field-label">ブロックアイコン</label>
									<div class="range-inputs">
										<select th:field="*{minCardBlockIcon}">
											<option value="">下限なし</option>
											<option th:each="num : ${#numbers.sequence(1,4)}"
													th:value="${num}" th:text="${num}">
											</option>
										</select>
										<span class="range-separator">〜</span>
										<select th:field="*{maxCardBlockIcon}">
											<option value="">上限なし</option>
											<option th:each="num : ${#numbers.sequence(1,4)}"
													th:value="${num}" th:text="${num}">
											</option>
										</select>
									</div>
								</div>
							</div>
							
							<div class="search-row">
								<div class="search-field range-field">
									<label class="field-label">コスト / ライフ</label>
									<div class="range-inputs">
										<select th:field="*{minCardCostOrLife}">
											<option value="">下限なし</option>
											<option th:each="num : ${#numbers.sequence(0,10)}"
													th:value="${num}" th:text="${num}">
											</option>
										</select>
										<span class="range-separator">〜</span>
										<select th:field="*{maxCardCostOrLife}">
											<option value="">上限なし</option>
											<option th:each="num : ${#numbers.sequence(0,10)}"
													th:value="${num}" th:text="${num}">
											</option>
										</select>
									</div>
								</div>
							</div>
							
							<div class="search-row">
								<div class="search-field range-field">
									<label class="field-label">パワー</label>
									<div class="range-inputs">
										<select th:field="*{minCardPower}">
											<option value="">下限なし</option>
											<option th:each="p : ${#numbers.sequence(0,13000,1000)}"
													th:value="${p}" th:text="${p}">
											</option>
										</select>
										<span class="range-separator">〜</span>
										<select th:field="*{maxCardPower}">
											<option value="">上限なし</option>
											<option th:each="p : ${#numbers.sequence(0,13000,1000)}"
													th:value="${p}" th:text="${p}">
											</option>
										</select>
									</div>
								</div>
							</div>
							
							<div class="search-row">
								<div class="search-field full-width">
									<label class="field-label">カウンター値</label>
									<div class="checkbox-group">
										<th:block th:each="counter : ${T(jp.co.sss.onepiececardviewer.enums.CardCounter).values()}">
											<label class="checkbox-label">
												<input type="checkbox"
														th:field="*{cardCounter}" 
														th:value="${counter.dbValue}" />
												<span class="checkbox-text" th:text="${counter.displayName}"></span>
											</label>
										</th:block>
									</div>
								</div>
							</div>
						</div>
						
						<div class="search-section">
							<div class="search-row">
								<div class="search-field full-width">
									<label class="field-label">属性</label>
									<div class="checkbox-group">
										<th:block th:each="feature : ${T(jp.co.sss.onepiececardviewer.enums.CardFeatures).values()}">
											<label class="checkbox-label">
												<input type="checkbox" th:field="*{cardFeatures}" th:value="${feature}" />
												<span class="checkbox-text" th:text="${feature}"></span>
											</label>
										</th:block>
									</div>
								</div>
							</div>
							
							<div class="search-row">
								<div class="search-field half-width">
									<label class="field-label">特徴</label>
									<select th:field="*{cardAttribute}">
										<option value="">すべて</option>
										<option th:each="attribute : ${T(jp.co.sss.onepiececardviewer.enums.CardAttributes).values()}"
												th:value="${attribute}"
												th:text="${attribute.label}">
									</select>
								</div>
							</div>
						</div>
						
						<div class="search-section">
							<div class="search-row">
								<div class="search-field full-width">
									<label class="field-label">テキスト効果</label>
									<input type="text" th:field="*{cardText}" placeholder="テキスト効果を入力" />
								</div>
							</div>
							
							<div class="search-row">
								<div class="search-field full-width trigger-field">
									<label class="field-label">
										<input type="checkbox" th:field="*{cardTrigger}" th:value="1" />
										<span class="checkbox-text">トリガー</span>
									</label>
									<input type="text" th:field="*{cardTriggerText}" placeholder="トリガーテキストを入力" class="trigger-text-input" />
								</div>
							</div>
						</div>
						
						<div class="search-section">
							<div class="search-row">
								<div class="search-field full-width">
									<div class="checkbox-grid">
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardAppearance}" th:value="1" />
											<span class="checkbox-text">登場時</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardLaunchMain}" th:value="1" />
											<span class="checkbox-text">起動メイン</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardAttack}" th:value="1" />
											<span class="checkbox-text">アタック時</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardKO}" th:value="1" />
											<span class="checkbox-text">KO時</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardBlock}" th:value="1" />
											<span class="checkbox-text">ブロック時</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardDuringYourTurn}" th:value="1" />
											<span class="checkbox-text">自ターン中</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardDuringOpponentTurn}" th:value="1" />
											<span class="checkbox-text">相手ターン中</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardYourTurnEnd}" th:value="1" />
											<span class="checkbox-text">自ターン終了時</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardOpponentAttack}" th:value="1" />
											<span class="checkbox-text">相手アタック時</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardMain}" th:value="1" />
											<span class="checkbox-text">メイン効果</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardEventCounter}" th:value="1" />
											<span class="checkbox-text">イベントカウンター</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardOneTurn}" th:value="1" />
											<span class="checkbox-text">ターン1回</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardDonHang}" th:value="1" />
											<span class="checkbox-text">ドン!!×n</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardDonMinus}" th:value="1" />
											<span class="checkbox-text">ドン!!-n</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardBlocker}" th:value="1" />
											<span class="checkbox-text">ブロッカー</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardHaste}" th:value="1" />
											<span class="checkbox-text">速攻</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardDoubleAttack}" th:value="1" />
											<span class="checkbox-text">ダブルアタック</span>
										</label>
										<label class="checkbox-label">
											<input type="checkbox" th:field="*{cardVanish}" th:value="1" />
											<span class="checkbox-text">バニッシュ</span>
										</label>
									</div>
								</div>
							</div>
						</div>
						
						<div class="search-actions">
							<button type="submit" class="search-submit-btn">検索する</button>
						</div>
					</div>
				</form>
			</div>
			<!-- カードリスト -->
			<div class="createDeck-image-grid">
				<div class="createDeck-image-card" th:each="cardListForCreateDeck : ${cardListForCreateDecks}">
					<a href="javascript:void(0);" th:data-card-id="${cardListForCreateDeck.id}" onclick="openCardModal(this.dataset.cardId, 1)">
					    <img th:src="@{/card/list/file/{id}(id=${cardListForCreateDeck.id})}" th:alt="${cardListForCreateDeck.cardName}">
					</a>
				</div>
			</div>
			<!-- デッキ表示 -->
			<div class="createDeck-field">
				<div class="createDeck-field-over">
					<div id="displayLeader" class="createDeck-image-leaderCard" th:if="${leaderCard != null}">
						<a href="javascript:void(0);" th:data-card-id="${leaderCard.id}" onclick="openCardModal(this.dataset.cardId, 3)">
							<img th:src="@{/card/list/file/{id}(id=${leaderCard.id})}" th:alt="${leaderCard.cardName}">
						</a>
					</div>
					<div class="createDeck-image-detail">
						<label id="numberOfCardWarning" style="display: none;">
							<p>デッキ枚数が超過しています。</p>
						</label>
						<p>デッキのカード枚数:<span id="numberOfCard">0</span>枚</p>
						<p>キャラ:<span id="numberOfCharacter">0</span>枚</p>
						<p>イベント:<span id="numberOfEvent">0</span>枚</p>
						<p>ステージ:<span id="numberOfStage">0</span>枚</p>
					</div>
					<div class="createDeck-keep-deck" th:if="${leaderCard != null}">
						<button id="openDeckModal" class="createDeck-keep-deck-button">確認/保存</button>
						<form th:action="@{/cancel/deck/creation/{id}(id=${leaderCard.id})}">
							<button type="submit">キャンセル</button>
						</form>
					</div>
				</div>
				<div class="createDeck-field-under">
					<div id="displayDeck" class="createDeck-display-image-grid">
						<!-- ここでカードの画像表示 -->
					</div>
				</div>
			</div>
		</div>
		
		<!-- カードモーダルダイアログ -->
		<div id="cardModal" class="createDeck-modal">
			<div class="createDeck-modal-content">
				<span class="createDeck-modal-close" onclick="closeCardModal()">&times;</span>
				<div class="createDeck-modal-body">
					<div id="modalText" class="createDeck-modal-text">
						<p>枚数を選択してください。</p>
					</div>
					<div class="createDeck-modal-image">
						<img id="modalImage" src="" alt="NoImage">
					</div>
					<div class="createDeck-modal-cardName">
						<p><span id="modalCardName"></span></p>
					</div>
					<label id="buttonLabel">
						<div class="createDeck-modal-numberOfCards">
							<div id="counter" class="createDeck-counter">0</div>
							<div>
								<button id="buttonDown" class="createDeck-button-down" onclick="decrease()">-</button>
								<button id="buttonUp" class="createDeck-button-up" onclick="">+</button>
							</div>
						</div>
					</label>
					<label id="additionLabel" style="display: none;">
						<button id="addition" class="createDeck-button-addition" data-type="" data-cost="" data-id="">追加</button>
					</label>
					<label id="changeLabel" style="display: none;">
						<button id="change" class="createDeck-button-addition" data-type="" data-cost="" data-id="">変更</button>
					</label>
				</div>
			</div>
		</div>
		
		<!-- デッキモーダルダイアログ -->
		<div id="deckModal" class="createDeck-keep-deck-modal">
			<div class="createDeck-keep-deck-modal-content">
				<span class="createDeck-keep-deck-modal-close" onclick="closeDeckModal()">&times;</span>
				<div class="createDeck-keep-deck-modal-body" th:if="${leaderCard != null}">
					<form th:action="@{/confirm/deck/{id}(id=${leaderCard.id})}" method="post" onsubmit="saveDeckToSession()" novalidate>
						<input type="hidden" id="keepDeckDataField" name="deckData" value="" />
						<div class="createDeck-keep-deck-modal-text">
							<p>このデッキを保存しますか。</p>
						</div>
						<div id="modalDeckWarning" class="createDeck-keep-deck-modal-warning-text">
							<!-- ここで警告文表示 -->
						</div>
						<div class="createDeck-keep-deck-modal-cards-container">
						    <div id="modalDeckLeader" class="createDeck-keep-deck-modal-leader-image">
								<!-- ここでリーダーカード表示 -->
							</div>
							<div id="modalDeck" class="createDeck-keep-deck-modal-image">
								<!-- ここでカードの画像表示 -->
						 	</div>
						</div>
						<div class="createDeck-keep-deck-modal-button">
							<button type="submit">保存</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</main>
	
	<script th:inline="javascript">
		/*<![CDATA[*/
		// サーバーからdeckCardsデータを取得（nullの場合は空配列）
		const initialDeckCards = /*[[${deckCards}]]*/ null;
		/*]]>*/
	</script>
	
	<script>
		// 詳細検索表示
		function toggleDetailSearch() {
			const detailArea = document.getElementById('detailSearchArea');
			const button = document.querySelector('.createDeck-search-toggle-btn');
			
			if (detailArea.classList.contains('active')) {
				detailArea.classList.remove('active');
				button.textContent = '詳細検索';
			} else {
				detailArea.classList.add('active');
				button.textContent = '詳細検索を閉じる';
			}
		}
		
		let count = 0;
		const MIN = 0;
		const MAX = 4;
		
		// カウンタの数字を減らす関数
		function decrease() {
			if (count > MIN) {
				count--;
				updateCount();
			}
		}
		
		// カウンタの数字を増やす関数
		function increase(cardId) {
			const currentTotal = document.querySelectorAll(`#displayDeck img[data-id="${cardId}"]`).length;
			if (count < MAX - currentTotal) {
				count++;
				updateCount();
			}
		}
		
		// カウンタの数字を増やす関数2
		function increase2() {
			if (count < MAX) {
				count++;
				updateCount();
			}
		}
		
		// カウンタの数字を更新する関数
		function updateCount() {
			document.getElementById('counter').textContent = count;
		}
		
		// id=displayDeck内にimgタグを指定した数だけ追加する関数
		function additionImage(count, id, type, cost) {
			if (count === 0) {
				closeCardModal();
				return;
			}
			
			for (let i = 0; i < count; i++) {
				const a = document.createElement('a');
				a.href = 'javascript:void(0);';
				a.setAttribute('data-id', id);
				a.addEventListener('click', function() {
					openCardModal(id, 2);
				});
				
				const img = document.createElement('img');
				img.id = 'modalDeckImage';
				img.src = '/card/list/file/' + id;
				img.alt = 'NoImage';
				img.className = 'createDeck-display-image-card';
				img.setAttribute('data-type', type);
				img.setAttribute('data-cost', cost);
				img.setAttribute('data-id', id);
				
				a.appendChild(img);
				displayDeck.appendChild(a);
			}
		}
		
		// id=displayDeck内にimgタグを指定した数だけ削除する関数
		function deleteImage(count, currentTotal, id) {
			if (count === currentTotal) {
				closeCardModal();
				return;
			}
			
			for (let i = 0; i < currentTotal - count; i++) {
				const a = document.querySelector(`#displayDeck a[data-id="${id}"]`);
				if (a) {
					a.remove();
				}
			}
		}
		
		// デッキ内のカード画像を並び替える関数
		function sortDeckImage(container, images) {
			images.sort((a, b) => {
				// 第一条件:cardType
				const typeA = parseInt(a.dataset.type) || 0;
				const typeB = parseInt(b.dataset.type) || 0;
				if (typeA !== typeB) {
					return typeA - typeB;
				}
				
				// 第二条件:cardCostOrLife
				const costA = parseInt(a.dataset.cost) || 0;
				const costB = parseInt(b.dataset.cost) || 0;
				if (costA !== costB) {
					return costA - costB;
				}
				
				// 第三条件:id
				const idA = parseInt(a.dataset.id) || 0;
				const idB = parseInt(b.dataset.id) || 0;
				return idA - idB;
			});
			
			// ソートした順序でDOMを再配
			images.forEach(img => {
				const parent = img.parentElement;
				if (parent && parent.tagName === 'A') {
					container.appendChild(parent);
				}
			});
		}
		
		// デッキ情報をフォームに追加する関数
		function saveDeckToSession() {
			const displayDeck = document.getElementById('displayDeck');
			const images = displayDeck.querySelectorAll('img');
			const deckData = [];
			
			images.forEach(img => {
				deckData.push({
					id: img.dataset.id,
					type: img.dataset.type,
					cost: img.dataset.cost
				});
			});
			
			const jsonData = JSON.stringify(deckData);
			
			// 両方のフィールドに設定
			const searchField = document.getElementById('searchDeckDataField');
			const keepField = document.getElementById('keepDeckDataField');
			
			if (searchField) searchField.value = jsonData;
			if (keepField) keepField.value = jsonData;
		}
		
		// デッキ枚数を更新する関数
		function updateDeckCounts() {
			const displayDeck = document.getElementById('displayDeck');
			const imgCount = displayDeck.querySelectorAll('img').length;
			const imgCountCharacter = displayDeck.querySelectorAll('img[data-type="1"]').length;
			const imgCountEvent = displayDeck.querySelectorAll('img[data-type="2"]').length;
			const imgCountStage = displayDeck.querySelectorAll('img[data-type="3"]').length;
			
			document.getElementById("numberOfCard").textContent = imgCount;
			document.getElementById("numberOfCharacter").textContent = imgCountCharacter;
			document.getElementById("numberOfEvent").textContent = imgCountEvent;
			document.getElementById("numberOfStage").textContent = imgCountStage;
			
			if (imgCount > 50) {
				document.getElementById('numberOfCardWarning').style.display = 'block';
			} else {
				document.getElementById('numberOfCardWarning').style.display = 'none';
			}
		}
		
		// デッキにカードを追加する
		document.getElementById('addition').addEventListener('click', function() {
			const displayDeck = document.getElementById('displayDeck');
			const addition = document.getElementById('addition');
			const type = addition.dataset.type;
			const cost = addition.dataset.cost;
			const id = addition.dataset.id;
			
			additionImage(count, id, type, cost);
			
			const container = document.querySelector('#displayDeck');
			const images = Array.from(container.querySelectorAll('img'));
			
			sortDeckImage(container, images);
			
			count = 0;
			updateCount();
			closeCardModal();
			
			const imgCount = displayDeck.querySelectorAll('img').length;
			const imgCountCharacter = displayDeck.querySelectorAll('img[data-type="1"]').length;
			const imgCountEvent = displayDeck.querySelectorAll('img[data-type="2"]').length;
			const imgCountStage = displayDeck.querySelectorAll('img[data-type="3"]').length;
			
			document.getElementById("numberOfCard").textContent = imgCount;
			document.getElementById("numberOfCharacter").textContent = imgCountCharacter;
			document.getElementById("numberOfEvent").textContent = imgCountEvent;
			document.getElementById("numberOfStage").textContent = imgCountStage;
			
			if (imgCount > 50) {
				document.getElementById('numberOfCardWarning').style.display = 'block';
			} else {
				document.getElementById('numberOfCardWarning').style.display = 'none';
			}
		})
		
		// デッキ内のカード枚数を変更する
		document.getElementById('change').addEventListener('click', function() {
			const displayDeck = document.getElementById('displayDeck');
			const addition = document.getElementById('change');
			const type = addition.dataset.type;
			const cost = addition.dataset.cost;
			const id = addition.dataset.id;
			const currentTotal = document.querySelectorAll(`#displayDeck img[data-id="${id}"]`).length;
			
			if (count - currentTotal > 0) {
				additionImage(count - currentTotal, id, type, cost);
				
				const container = document.querySelector('#displayDeck');
				const images = Array.from(container.querySelectorAll('img'));
				
				sortDeckImage(container, images);
			} else if (count - currentTotal < 0) {
				deleteImage(count, currentTotal, id)
			} else {
				count = 0;
				updateCount();
				closeCardModal();
			}
			
			count = 0;
			updateCount();
			closeCardModal();
			
			const imgCount = displayDeck.querySelectorAll('img').length;
			const imgCountCharacter = displayDeck.querySelectorAll('img[data-type="1"]').length;
			const imgCountEvent = displayDeck.querySelectorAll('img[data-type="2"]').length;
			const imgCountStage = displayDeck.querySelectorAll('img[data-type="3"]').length;
			
			document.getElementById("numberOfCard").textContent = imgCount;
			document.getElementById("numberOfCharacter").textContent = imgCountCharacter;
			document.getElementById("numberOfEvent").textContent = imgCountEvent;
			document.getElementById("numberOfStage").textContent = imgCountStage;
			
			if (imgCount > 50) {
				document.getElementById('numberOfCardWarning').style.display = 'block';
			} else {
				document.getElementById('numberOfCardWarning').style.display = 'none';
			}
		})
		
		// ページ読み込み時に初期デッキを表示
		window.addEventListener('DOMContentLoaded', function() {
			// deckCardsがnullでなく、配列で、要素がある場合のみ実行
			if (initialDeckCards && Array.isArray(initialDeckCards) && initialDeckCards.length > 0) {
				loadInitialDeck(initialDeckCards);
		 	}
			updateDeckCounts();
		});
		
		// 初期デッキを読み込む関数
		async function loadInitialDeck(deckCards) {
			const displayDeck = document.getElementById('displayDeck');
			
			for (const card of deckCards) {
				try {
					// カードの詳細を取得
					const cardResponse = await fetch('/card/list/detail/' + card.id);
					if (!cardResponse.ok) {
						throw new Error('リーダーカード情報の取得に失敗しました');
					}
					const deckCard = await cardResponse.json();
					
					
					const a = document.createElement('a');
					a.href = 'javascript:void(0);';
					a.setAttribute('data-id', card.id);
			 		a.addEventListener('click', function() {
						openCardModal(card.id, 2);
					});
					
					// dataType変数を定義
					let dataType;
					if (deckCard.cardType === 'キャラ') {
						dataType = '1';
					} else if (deckCard.cardType === 'イベント') {
						dataType = '2';
					} else {
						dataType = '3';
					}
					
					const img = document.createElement('img');
					img.id = 'modalDeckImage';
			 		img.src = '/card/list/file/' + card.id;
					img.alt = 'NoImage';
			  		img.className = 'createDeck-display-image-card';
					img.setAttribute('data-type', dataType);
					img.setAttribute('data-cost', deckCard.cardCostOrLife);
					img.setAttribute('data-id', card.id);
				
					a.appendChild(img);
					displayDeck.appendChild(a);
					
					updateDeckCounts();
				} catch (error) {
					console.error('エラー:', error);
				}
			}
			
			// ソート
			const container = document.querySelector('#displayDeck');
			const images = Array.from(container.querySelectorAll('img'));
			sortDeckImage(container, images);
		}
		
		// 右クリックメニュー関連（右クリックで即座に追加・削除）
		document.addEventListener('DOMContentLoaded', function() {
			// カードリスト側の右クリック - 即座にデッキに追加
			document.querySelector('.createDeck-image-grid').addEventListener('contextmenu', async function(e) {
				const card = e.target.closest('.createDeck-image-card');
				if (card) {
					e.preventDefault();
					const link = card.querySelector('a');
					const cardId = link.dataset.cardId;
					
					const currentTotal = document.querySelectorAll(`#displayDeck img[data-id="${cardId}"]`).length;
					
					if (currentTotal >= 4) {
						//alert('このカードは既に4枚デッキに入っています');
						return;
					}
					
					try {
						const response = await fetch('/card/list/detail/' + cardId);
						if (!response.ok) throw new Error('カード情報の取得に失敗しました');
						const cardData = await response.json();
						
						let dataType;
						if (cardData.cardType === 'キャラ') {
							dataType = '1';
						} else if (cardData.cardType === 'イベント') {
							dataType = '2';
						} else if (cardData.cardType === 'ステージ') {
							dataType = '3';
						} else {
							dataType = '4';
						}
						
						additionImage(1, cardData.id, dataType, cardData.cardCostOrLife);
						
						const container = document.querySelector('#displayDeck');
						const images = Array.from(container.querySelectorAll('img'));
						sortDeckImage(container, images);
						
						updateDeckCounts();
					} catch (error) {
						console.error('エラー:', error);
						alert('カード情報の取得に失敗しました');
					}
				}
			});
			
			// デッキ表示側の右クリック - 即座に削除
			document.getElementById('displayDeck').addEventListener('contextmenu', function(e) {
				const link = e.target.closest('a[data-id]');
				if (link) {
					e.preventDefault();
					const cardId = link.dataset.id;
					
					link.remove();
					updateDeckCounts();
				}
			});
		});
		
		// カードモーダルを開く関数
		function openCardModal(cardId, number) {
			// デッキ内の画像をクリックした場合は、現在の枚数をcountに設定
			if (number === 2) {
				count = document.querySelectorAll(`#displayDeck img[data-id="${cardId}"]`).length;
			} else {
				count = 0;
			}
			updateCount();
			
			// Ajaxでカード詳細を取得
			fetch('/card/list/detail/' + cardId)
				.then(response => {
					if (!response.ok) {
						throw new Error('No Image');
					}
					return response.json();
				})
				.then(card => {
					// モーダルに情報を設定
					document.getElementById('modalImage').src = '/card/list/file/' + card.id;
					document.getElementById('modalCardName').textContent = card.cardName || '';
					
					// dataType変数を定義
					let dataType;
					if (card.cardType === 'キャラ') {
					    dataType = '1';
					} else if (card.cardType === 'イベント') {
					    dataType = '2';
					} else if (card.cardType === 'ステージ') {
					    dataType = '3';
					} else {
						dataType = '4';
					}
					document.getElementById('addition').setAttribute('data-type', dataType);
					document.getElementById('addition').setAttribute('data-cost', card.cardCostOrLife);
					document.getElementById('addition').setAttribute('data-id', card.id);
					document.getElementById('change').setAttribute('data-type', dataType);
					document.getElementById('change').setAttribute('data-cost', card.cardCostOrLife);
					document.getElementById('change').setAttribute('data-id', card.id);
					if (number === 1) {
						document.getElementById('modalText').style.display = 'block';
						document.getElementById('additionLabel').style.display = 'block';
						document.getElementById('changeLabel').style.display = 'none';
						document.getElementById('buttonLabel').style.display = 'block';
						document.getElementById('buttonUp').onclick = function() { increase(card.id) };
					} else if (number === 2) {
						document.getElementById('modalText').style.display = 'block';
						document.getElementById('additionLabel').style.display = 'none';
						document.getElementById('changeLabel').style.display = 'block';
						document.getElementById('buttonLabel').style.display = 'block';
						document.getElementById('buttonUp').onclick = function() { increase2() };
					} else {
						document.getElementById('modalText').style.display = 'none';
						document.getElementById('additionLabel').style.display = 'none';
						document.getElementById('changeLabel').style.display = 'none';
						document.getElementById('buttonLabel').style.display = 'none';
					}
					
					// モーダルを表示
					document.getElementById('cardModal').classList.add('active');
					
				})
				.catch(error =>{
					console.error('エラー:', error);
					alert('カード情報の取得に失敗しました');
				});
		}
		
		// デッキモーダルを開く
		document.getElementById('openDeckModal').addEventListener('click', () => {
			const displayDeck = document.getElementById('displayDeck');
			const displayLeader = document.getElementById('displayLeader');
			const modalDeck = document.getElementById('modalDeck');
			const modalDeckLeader = document.getElementById('modalDeckLeader');
			const modalDeckWarning = document.getElementById('modalDeckWarning');
			
			const images = displayDeck.querySelectorAll('img');
			const leaderImage = displayLeader.querySelector('img');
			const imgCount = displayDeck.querySelectorAll('img').length;
			
			// モーダル内をクリア
			modalDeck.innerHTML = '';
			modalDeckLeader.innerHTML = '';
			modalDeckWarning.innerHTML = '';
			
			// imgをコピーしてモーダルに追加
			if (leaderImage) {
				const clonedLeaderImg = leaderImage.cloneNode(true); // 画像を複製
				modalDeckLeader.appendChild(clonedLeaderImg);
			}
			images.forEach(image => {
				const clonedImg = image.cloneNode(true); // 画像を複製
				modalDeck.appendChild(clonedImg);
			});
			
			if (imgCount > 50) {
				const p = document.createElement('p');
				p.textContent = 'カード枚数が超過しています。'
				
				modalDeckWarning.appendChild(p);
			} else if (imgCount < 50) {
				const p = document.createElement('p');
				p.textContent = 'カード枚数が不足しています。'
				
				modalDeckWarning.appendChild(p);
			};
			
			// モーダルを表示
			document.getElementById('deckModal').classList.add('active');
		})
		
		// カードモーダルを閉じる関数
		function closeCardModal() {
			document.getElementById('cardModal').classList.remove('active');
			count = 0;
			updateCount();
		}
		
		// デッキモーダルを閉じる関数
		function closeDeckModal() {
			document.getElementById('deckModal').classList.remove('active');
		}
		
		// モーダルの背景をクリックしたら閉じる
		window.onclick = function(event) {
			const cardModal = document.getElementById('cardModal');
			const deckModal = document.getElementById('deckModal');
			
			if (event.target === cardModal) {
				closeCardModal();
			}
			if (event.target === deckModal) {
				closeDeckModal();
			}
		}
		
		// ESCキーでモーダルを閉じる
		document.addEventListener('keydown', function(event) {
			if (event.key === 'Escape') {
				closeCardModal();
				closeDeckModal()
			}
		})
		
		// ページ読み込み時にデッキ枚数を更新
		window.addEventListener('DOMContentLoaded', function() {
			updateDeckCounts();
		});
	</script>
</body>

</html>